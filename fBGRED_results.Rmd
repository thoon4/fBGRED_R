---
title: 'Revealing neural mechanisms of redundancy gain using a voxel-wise background connectivity analysis'
author: "Korea Brain Research Institute, Cognitive Science Research Group, Deep Memory Lab"
date: "`r Sys.Date()`"
output:
  github_document: default
  pdf_document:
    toc: true
    toc_depth: 5
  html_document:
    code_folding: hide
    highlight: tango
    number_sections: true
    theme: cosmo
    toc: true
    toc_depth: 5
    toc_float:
      collapse: false
      smooth_scroll: false
subtitle: Voxel Threshold p < .01 (z = +-2.58), Visual ROI generated by Meridian Mapping Procedure
mainfont: Noto Sans CJK KR
editor_options: 
  chunk_output_type: console
always_allow_html: yes  
---

<br><br>

# Abstract

<br>

A previous study demonstrated that the retinotopic cortex shows greater activity when identical stimuli are simultaneously presented on different visual quadrants, than when different stimuli are presented, which is termed 'redundancy gain'. A theoretical account for the phenomenon has been only suggestive: Responses in the early visual cortex are enhanced by feedback from higher cortical areas with larger receptive fields. Here we found the direct evidence supporting this account in an fMRI study. We calculated the voxel-wise functional connectivity between the early visual cortex and the higher-level scene-dplyr::selective region (PPA) by using the background connectivity analysis. We then examined how the strength of this functional connectivity modulates the redundancy gain. In the first phase of an experiment, four identical (same condition) or four different scene images (different condition) were simultaneously presented in each visual quadrant. We measured the redundancy gain in the early visual cortex by comparing the same and different conditions. In the second phase, participants were asked to attend to scene images while ignoring superimposed face images. Using this task, we identified the voxel-wise functional connectivity between the early visual cortex and PPA independently of stimulus-evoked responses. In line with the previous theoretical account that feedback from higher visual areas drives the redundancy gain effect, the voxels in the early visual cortex (V1-V4) showed greater redundancy gain when they had higher functional connectivity with PPA. Our findings shed light on the interactive mechanism explaining neural responses in the early retinotopic cortex.

<br><br>

****

<br>

****

<br>

# Results

```{r, echo=FALSE}
rm(list=ls())
# getwd()
setwd("/Users/taehoonkim/Desktop/Workspace/git_project/fBGRED_R/")
options(scipen=4)
```

```{css, echo=FALSE}
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
```


```{r setup, message=FALSE}
set.seed(12345) # for reproducibility
options(knitr.kable.NA = '')

# install // load packages 
# Some packages need to be loaded. 
# We use `pacman` as a package manager, which takes care of the other packages. 
if (!require("distill", quietly = TRUE)) install.packages("distill")
if (!require("devtools", quietly = TRUE)) install.packages("devtools")
if (!require("papaja", quietly = TRUE)) devtools::install_github("crsh/papaja")
if (!require("patchwork", quietly = TRUE)) devtools::install_github("thomasp85/patchwork")
if (!require("klippy", quietly = TRUE)) devtools::install_github("RLesur/klippy")
if (!require("pacman", quietly = TRUE)) install.packages("pacman")
if (!require("Rmisc", quietly = TRUE)) install.packages("Rmisc")
if (!require("ggbeeswarm", quietly = TRUE)) install.packages("ggbeeswarm") # Never load it directly.
pacman::p_load(tidyverse, papaja, knitr, dplyr, car, psych, afex, lme4, lmerTest, 
               emmeans, ggplot2, ggpubr, lattice, latticeExtra, parallel, effects, psycho, caret,
               effectsize, rstatix)
library("patchwork"); library("klippy")
klippy::klippy()
```
  
<br>

## Redundancy Gain Effect - Replication - Smoothed

<br>

### Behavioural Performance

<br>

Phase 1 Main Phase 의 central fixation task의 수행 요약치를 분석하였다.

<br>

```{r, collapse=TRUE}
p1 <- read.csv("data/main_behav.csv", header = T)

p1_l <- p1
p1_l$subj = factor(p1_l$subj)
p1_l <- p1_l %>% filter(subj!=99)
p1_l$run = factor(p1_l$run) 
p1_l$block = factor(p1_l$block) 
p1_l$cond = factor(p1_l$cond, levels=c(1,2,3), labels=c("single","same","diff")) 
# p1_l$catch = factor(p1_l$catch)
p1_l$rt = p1_l$rt*1000
p1_l$corr = 0
p1_l$corr[p1_l$catch==1 & p1_l$resp==1] = 1
p1_l$type = 0
p1_l$type[p1_l$catch==1 & p1_l$resp==1] = 1 #hit
p1_l$type[p1_l$catch==1 & p1_l$resp==0] = 2 #miss
p1_l$type[p1_l$catch==0 & p1_l$resp==1] = 3 #fa
p1_l$type[p1_l$catch==0 & p1_l$resp==0] = 4 #cr
p1_l$type <- factor(p1_l$type, levels=c(1,2,3,4), labels=c("hit","miss","fa","cr"))

headTail(p1_l)
glimpse(p1_l, width = 70)

```
  
<br>

제시 조건을 구분하지 않은 전반적인 요약치 d prime은 아래와 같다.

<br>
  
```{r, collapse=TRUE}
# subject-level, long format
dmy <- dummyVars(" ~ type", data = p1_l)
p1_2 <- data.frame(predict(dmy, newdata = p1_l))
p1_3 <- cbind(p1_l, p1_2)
p1_allL <- p1_3  %>% group_by(subj) %>%
  dplyr::summarise(hit=sum(`type.hit`), 
                   miss=sum(`type.miss`), 
                   fa=sum(`type.fa`),
                   cr=sum(`type.cr`),
                   targets=sum(`type.hit`)+sum(`type.miss`),
                   dists=sum(`type.fa`)+sum(`type.cr`),
                   hit.r=sum(`type.hit`)/(sum(`type.hit`)+sum(`type.miss`)), 
                   miss.r=sum(`type.miss`)/(sum(`type.hit`)+sum(`type.miss`)),
                   fa.r=sum(`type.fa`)/(sum(`type.fa`)+sum(`type.cr`)),
                   cr.r=sum(`type.cr`)/(sum(`type.fa`)+sum(`type.cr`))) %>%
  ungroup()

# subject-level, long format, calculating dprime
indices <- psycho::dprime(p1_allL$hit, p1_allL$fa, p1_allL$miss, p1_allL$cr, 
                          p1_allL$targets, p1_allL$dists)
indices <- psycho::dprime(p1_allL$hit.r, p1_allL$fa.r, p1_allL$miss.r, p1_allL$cr.r, 
                          1, 1)

p1_allL2 <- cbind(p1_allL, indices)
# p1_allL2 %>% kable(digits=2)

# check outlier
p1_allL3 <- p1_allL2 %>%
  mutate(lbound = mean(dprime)-3*sd(dprime),
         ubound = mean(dprime)+3*sd(dprime)) %>% 
  mutate(Outlier = (dprime < lbound)|(dprime > ubound)) %>% # set outlier
  ungroup()
p1_allL3$cond <- 1; p1_allL3$cond <- factor(p1_allL3$cond)
# p1_allL3 %>% dplyr::select(subj, hit, miss, fa, cr, dprime) %>% kable(digits=2)

# summary table: grand mean
p1_allG <- p1_allL3 %>% 
  summarise(dprime.m = mean(dprime), dprime.sd = sd(dprime)) %>%
  ungroup()
p1_allG$dprime.se <- Rmisc::summarySE(data = p1_allL3, measurevar = "dprime")$se
p1_allG$dprime.ci <- Rmisc::summarySE(data = p1_allL3, measurevar = "dprime")$ci
p1_allG <- p1_allG %>% 
  mutate(lower.ci = dprime.m-dprime.ci,
         upper.ci = dprime.m+dprime.ci)
p1_allG$cond <- 1; p1_allG$cond <- factor(p1_allG$cond)
p1_allG %>% dplyr::select(dprime.m, dprime.sd, dprime.se, lower.ci, upper.ci) %>% kable(digits=2)
```

<br>

```{r, echo=T}

p_h1 <- p1_allL3 %>% 
  rstatix::t_test(dprime ~ 1, mu = 0, detailed= T, alternative = "two.sided") %>% 
  dplyr::select(estimate, conf.low, conf.high, df, statistic, p) 

p_h2 <- p1_allL3 %>% 
  rstatix::cohens_d(dprime ~ 1, mu = 0, ci = F) %>% 
  dplyr::select(effsize, magnitude) 

merge(p_h1, p_h2) %>% kable(digits=3)
```

<br>

제시 조건(single vs. 4-same vs. 4-different)에 따른 차이가 있는지 분석하였다. 요약치는 아래와 같다.

<br>
  
```{r, collapse=TRUE}
# subject-level, long format
dmy <- dummyVars(" ~ type", data = p1_l)
p1_2 <- data.frame(predict(dmy, newdata = p1_l))
p1_3 <- cbind(p1_l, p1_2)

p1_allL <- p1_3  %>% group_by(subj, cond) %>%
  dplyr::summarise(hit=sum(`type.hit`), 
                   miss=sum(`type.miss`), 
                   fa=sum(`type.fa`),
                   cr=sum(`type.cr`),
                   targets=sum(`type.hit`)+sum(`type.miss`),
                   dists=sum(`type.fa`)+sum(`type.cr`),
                   hit.r=sum(`type.hit`)/(sum(`type.hit`)+sum(`type.miss`)), 
                   miss.r=sum(`type.miss`)/(sum(`type.hit`)+sum(`type.miss`)),
                   fa.r=sum(`type.fa`)/(sum(`type.fa`)+sum(`type.cr`)),
                   cr.r=sum(`type.cr`)/(sum(`type.fa`)+sum(`type.cr`))) %>%
  ungroup()
# p1_allL %>% kable(digits=2)

# subject-level, long format, calculating dprime
# indices <- psycho::dprime(p1_allL$hit, p1_allL$fa, p1_allL$miss, p1_allL$cr, 
#                           p1_allL$targets, p1_allL$dists)
indices <- psycho::dprime(p1_allL$hit.r, p1_allL$fa.r, p1_allL$miss.r, p1_allL$cr.r, 
                          1, 1)

p1_allL2 <- cbind(p1_allL, indices)
# p1_allL2 %>% kable(digits=2)

# check outlier
p1_allL3 <- p1_allL2 %>% group_by(cond) %>% 
  mutate(lbound = mean(dprime)-3*sd(dprime),
         ubound = mean(dprime)+3*sd(dprime)) %>% 
  mutate(Outlier = (dprime < lbound)|(dprime > ubound)) %>% # set outlier
  ungroup()
# p1_allL3$cond <- 1; p1_allL3$cond <- factor(p1_allL3$cond)
# p1_allL3 %>% dplyr::select(subj, hit, miss, fa, cr, dprime) %>% kable(digits=2)

# summary table: grand mean
p1_allG <- p1_allL3 %>% group_by(cond) %>% 
  summarise(dprime.m = mean(dprime), dprime.sd = sd(dprime)) %>%
  ungroup()

p1_allG$dprime.se <- Rmisc::summarySEwithin(data = p1_allL3, measurevar = "dprime", idvar = "subj", 
                                      withinvars = c("cond"))$se
p1_allG$dprime.ci <- Rmisc::summarySEwithin(data = p1_allL3, measurevar = "dprime", idvar = "subj", 
                                            withinvars = c("cond"))$ci

p1_allG <- p1_allG %>% group_by(cond) %>% 
  mutate(lower.ci = dprime.m-dprime.ci,
         upper.ci = dprime.m+dprime.ci)
# p1_allG$cond <- 1; p1_allG$cond <- factor(p1_allG$cond)
p1_allG %>% dplyr::select(dprime.m, dprime.sd, dprime.se, lower.ci, upper.ci) %>% kable(digits=2)
```

<br>

RM anova 결과, 참가자들의 수행에서 제시 조건에 따른 차이는 유의하지 않았다.

<br>

```{r, echo=T}

p1.aov1 <- aov_ez(id="subj", dv="dprime", data = p1_allL3, within = c("cond"),
                  anova_table = list(correction = "none"))
# summary(t1.aov1)
nice(p1.aov1, es="pes") %>% kable(digits=3)

```

<br>

조건 간 짝 비교에서도 유의한 차이는 관찰되지 않았다.

<br>

```{r, collapse=TRUE}
p_h1 <- p1_allL3 %>% 
  rstatix::pairwise_t_test(dprime ~ cond, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif)

p_h2 <- p1_allL3 %>% 
  rstatix::cohens_d(dprime ~ cond, paired=T, ci = F) %>% 
  dplyr::select(group1, group2, effsize, magnitude)

merge(p_h1, p_h2, by = c("group1", "group2")) %>% kable(digits=3)

```

<br>

### fMRI results

<br>
  
전체 관심 영역 (PPA, V1~V4) 에서 Redundancy Gain Effect 를 확인하였다. 자극 제시 조건은 Single, 4-Same, 4-Different으로 구분되었다. 이 분석에서는 전처리 과정에서 FWHM 5mm로 Spatial Smoothing이 수행된 데이터를 사용하였다.

<br>

```{r, collapse=TRUE}
# hRoi
t3 <- read.csv("data/p12_RG_main1_hroi_sm.csv", header = T)
# t3 <- read.csv("p12_RG_main1_hroi_nsm.csv", header = T)


t3_l <- t3
# change class of main factors: double to factor
t3_l$subj = factor(t3_l$subj, levels=c("rd_01","rd_02","rd_03","rd_04","rd_05",
                                       "rd_06","rd_07","rd_08","rd_09","rd_10",
                                       "rd_11","rd_12","rd_13","rd_14","rd_15",
                                       "rd_16", "rd_18", "rd_19", "rd_20",
                                       "rd_21", "rd_22", "rd_23", "rd_24", "rd_25"), 
                   labels=c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,19,20,21,22,23,24,25))

t3_l <- gather(t3_l, key = rgCon, value = z, sing1_l:diff, factor_key=T)
t3_l$rgCon = factor(t3_l$rgCon, 
                    levels=c("sing1_l","sing2_r","sing3_r","sing4_l","sing","same","diff"),
                    labels=c("sing1_l","sing2_r","sing3_r","sing4_l","single","same","diff")) 
targ_rgCon = c("single","same","diff")
t3_l <- t3_l %>% filter(rgCon %in% targ_rgCon)
# targ_hRoi = c("ffa","ppa")
t3_l$hRoi = factor(t3_l$hRoi, 
                   levels=c("rFFA","lFFA","FFA","rPPA","lPPA","PPA"), 
                   labels=c("rFFA","lFFA","FFA","rPPA","lPPA","PPA"))
t3_l$Roi <- t3_l$hRoi
t3_l <- t3_l %>% 
  filter(Roi != "FFA", Roi != "rFFA", Roi != "lFFA") %>% 
  dplyr::select(subj, Roi, rgCon, z)

# vRoi
t4 <- read.csv("data/p12_RGandBG_ms_main13_sm.csv", header = T)
# t4 <- read.csv("p12_RGandBG_ms_main13_nsm.csv", header = T)

t4_l <- gather(t4, vRoi, z, v1:v4, factor_key=TRUE)
# change class of main factors: double to factor
t4_l$subj = factor(t4_l$subj, levels=c("rd_01","rd_02","rd_03","rd_04","rd_05",
                                       "rd_06","rd_07","rd_08","rd_09","rd_10",
                                       "rd_11","rd_12","rd_13","rd_14","rd_15",
                                       "rd_16", "rd_18", "rd_19", "rd_20",
                                       "rd_21", "rd_22", "rd_23", "rd_24", "rd_25"), 
                   labels=c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,19,20,21,22,23,24,25))

t4_l$vRoi = factor(t4_l$vRoi) 
t4_l$bgCon = factor(t4_l$bgCon, 
                    levels=c("rPPA","lPPA","PPA","tPPA"), 
                   labels=c("rPPA","lPPA","PPA","tPPA"))
t4_l$fcCon =factor(t4_l$fcCon, levels=c("low","high","all"))
t4_l$rgCon =factor(t4_l$rgCon, levels=c("single","same","diff"))
t4_l$Roi <- t4_l$vRoi
t4_l <- t4_l %>% filter(fcCon == "all", bgCon == "PPA") %>% dplyr::select(subj, Roi, rgCon, z)
t34 <- rbind(t3_l, t4_l)

# t34 <- t34 %>% filter(subj != 4, subj != 5, subj != 6, subj != 8)

glimpse(t34, width = 70)

```

<br>

각 관심 영역에서 자극 제시 조건에 따른 활성화 값의 요약치는 아래와 같다.

<br>

```{r, collapse=TRUE}
t34_allL.1 <- t34 %>% 
  group_by(subj, Roi, rgCon) %>%
  dplyr::summarise(z=mean(z)) %>%
  ungroup()
# t34_allL.1 %>% kable(digits=2)

# subject-level, wide format
t34_allW.1 <- t34_allL.1 %>% spread(key=rgCon, value = z)
# t34_allW.1 %>% filter(Roi != "ppa") %>% mutate(same_diff = same-diff) %>%
#   dplyr::select(subj, Roi, same_diff) %>% spread(key=Roi, value=same_diff) %>%
#   kable(digits=2)

# summary table: grand mean
t34_allG.1 <- t34_allL.1 %>% group_by(Roi, rgCon) %>%
  summarise(z.m = mean(z), z.sd = sd(z)) %>%
  ungroup()
t34_allG.1$z.se <- Rmisc::summarySEwithin(data = t34_allL.1, measurevar = "z", 
                                         idvar = "subj", withinvars = c("Roi", "rgCon"))$se
t34_allG.1$z.ci <- Rmisc::summarySEwithin(data = t34_allL.1, measurevar = "z", 
                                         idvar = "subj", withinvars = c("Roi", "rgCon"))$ci
t34_allG.1 <- t34_allG.1 %>% 
  mutate(lower.ci = z.m-z.ci,
         upper.ci = z.m+z.ci,
         lower.se = z.m-z.se,
         upper.se = z.m+z.se)
t34_allG.1 %>% dplyr::select(Roi, rgCon, z.m) %>% spread(key=rgCon, value=z.m) %>%  kable(digits=2)

```

<br>

아래 그래프는 각 관심 영역에서 자극 제시 조건에 따른 활성화 값(z)을 나타낸다. 그래프에서 Same > Diff > Single 조건 순서로 활성화가 높게 나타나는 것을 Redundancy Gain Effect로 해석한다. 점은 평균, error bar는 95% ci를 나타내었다.

<br>


```{r, fig.width= 14, fig.height=6}
targ_roi = c("PPA","v1","v2","v3","v4")
r1_hroi <- t34_allL.1 %>% filter(Roi %in% targ_roi)
# Roi != "v1", Roi != "v2", Roi != "v3", Roi != "v4")
r1_hroi_w <- t34_allW.1 %>% filter(Roi %in% targ_roi)
r1_hroi_g <- t34_allG.1 %>% filter(Roi %in% targ_roi)
r1_hroi_g$z <- r1_hroi_g$z.m
r1_main_allroi <- ggplot(data=r1_hroi, aes(x=Roi, y=z, fill=rgCon)) +
  # geom_hline(yintercept=0, linetype='solid', color='black', alpha =1, size=0.2) +
  stat_summary(fun = mean, geom = "bar", position="dodge", na.rm = TRUE,   
               alpha = .9, width = 0.8,  size = 0.5, color = "gray20") +
  geom_dotplot(data=r1_hroi, aes(x=Roi, y=z, fill=rgCon),
               binaxis = "y", stackdir = "center", stackratio = 1,
               color = "black", alpha = 0.5, #position = "nudge",
               position=position_dodge(0.8),
               inherit.aes = TRUE, binwidth = 0.15) +
  # geom_jitter(aes(x=Roi, y=z, fill=rgCon, color = rgCon),
  #             position=position_dodge(0.1), cex=2
  #             ) +

  # facet_grid(.~Btw, scales="free_x", space = "free",
  #            labeller = labeller(Btw = c("1" = "Experimental Group","2" = "Control Group"))) +
  # geom_point(data=r1_hroi, aes(x=Roi, y=z, fill=rgCon), position = position_dodge(width=0.8),
             # size=2, show.legend=F, color="gray90") +  
  # geom_segment(data=filter(r1_hroi_w, Roi == "ffa"), inherit.aes = FALSE,
  #              aes(x=0.73, y=filter(r1_hroi_w, Roi == "ffa")$single,
  #                  xend=1.0, yend=filter(r1_hroi_w, Roi == "ffa")$same),
  #              color="gray90", alpha = .7) +  
  # geom_segment(data=filter(r1_hroi_w, Roi == "ffa"), inherit.aes = FALSE,
  #              aes(x=1, y=filter(r1_hroi_w, Roi == "ffa")$same,
  #                  xend=1.27, yend=filter(r1_hroi_w, Roi == "ffa")$diff),
  #              color="gray90", alpha = .7) +  
  # geom_segment(data=filter(r1_hroi_w, Roi == "ppa"), inherit.aes = FALSE,
  #              aes(x=1.73, y=filter(r1_hroi_w, Roi == "ppa")$single,
  #                  xend=2.0, yend=filter(r1_hroi_w, Roi == "ppa")$same),
  #              color="gray90", alpha = .7) +  
  # geom_segment(data=filter(r1_hroi_w, Roi == "ppa"), inherit.aes = FALSE,
  #              aes(x=2, y=filter(r1_hroi_w, Roi == "ppa")$same,
  #                  xend=2.27, yend=filter(r1_hroi_w, Roi == "ppa")$diff),
  #              color="gray90", alpha = .7) +  
  # geom_pointrange(data=r1_hroi_g, aes(x = Roi, y=z.m, ymin = lower.ci, ymax = upper.ci),
                  # position = position_dodge(0.80), color = "darkred", size = 1, show.legend = FALSE) +
  geom_errorbar(data=r1_hroi_g, aes(ymin=lower.se, ymax=upper.se), width=.2,
                position=position_dodge(.8), color = "black") +
  scale_x_discrete(labels=c("PPA","V1","V2","V3","V4")) +
  scale_fill_manual(values = c("#D2E6BD", "#4AA7B4", "#235796"),  # , "#235796"
                    labels = c("single", "4-same", "4-diff")) +
  coord_cartesian(ylim = c(-2, 15), clip = "on") +
  labs(x = "", y = expression(paste("Parameter estimation (", italic("z"), ")"))) +
  theme_bw(base_size = 18) +
  theme(axis.title = element_text(face = "bold", size = 16, color = "black"),
        axis.text = element_text(face = "plain", hjust = 0.5, size = 15, color = "black"),
        axis.line=element_line(),
        axis.text.x = element_text(face = "plain", vjust = -1, size = 15, color = "black"),
        strip.text.x = element_text(face = "plain", size = 15, color = "black"),
        strip.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing=unit(1, "lines"),
        plot.margin = margin(1, 0.3, 1, 0.3, "cm"), 
        legend.title = element_blank(),
        legend.position="top")
r1_main_allroi
# ggsave("fBGRED_main12_verSM.jpg", plot = r1_main_allroi, width=8, height=6, unit='in', dpi=600)
```

<br>

각 관심 영역(PPA, V1, V2, V3, V4)에서 자극 제시 조건(Single vs. 4-Same vs. 4-Diff)을 요인으로 4 x 3 혼합 요인 분산분석을 수행하였다. 분석 결과에서 각 관심 영역 간 차이는 관심 효과가 아님에 유의할 필요가 있다.

<br>

```{r, collapse=TRUE}
targ_roi = c("PPA", "v1", "v2", "v3", "v4")
t34_allL.1.vroi <- t34_allL.1 %>% filter(Roi %in% targ_roi)
t34.aov1 <- aov_ez(id="subj", dv="z", data = t34_allL.1.vroi, within = c("Roi", "rgCon"),
                   anova_table = list(correction = "none"))
nice(t34.aov1, es="pes") %>% kable(digits=3)
```

<br>

각 관심 영역에서 자극 제시 조건에 따른 차이를 사후 검정하였다.

<br>

```{r, collapse=TRUE}
p_h1 <- t34_allL.1.vroi %>% 
  group_by(Roi) %>% 
  rstatix::pairwise_t_test(z ~ rgCon, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(Roi, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif)

p_h2 <- t34_allL.1.vroi %>% group_by(Roi) %>% 
  rstatix::cohens_d(z ~ rgCon, paired=T, ci = F) %>% 
  dplyr::select(Roi, group1, group2, effsize, magnitude)

merge(p_h1, p_h2, by = c("Roi", "group1", "group2")) %>% filter(group1=="single") %>%  kable(digits=3)

merge(p_h1, p_h2, by = c("Roi", "group1", "group2")) %>% filter(group1=="same") %>% kable(digits=3)
```


**V1 결과**

```{r, collapse=TRUE}
t34_allL.1.tmp <- t34_allL.1 %>% filter(Roi=="v1")
t34.aov1 <- aov_ez(id="subj", dv="z", data = t34_allL.1.tmp, within = c("rgCon"),
                   anova_table = list(correction = "none"))
nice(t34.aov1, es="pes") %>% kable(digits=3)

t34_allL.1.tmp %>% group_by(Roi) %>% rstatix::pairwise_t_test(z ~ rgCon, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(Roi, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) %>% kable(digits=3)

t34_allL.1.tmp %>% group_by(Roi) %>% 
  rstatix::cohens_d(z ~ rgCon, paired=T, ci = F) %>% kable(digits=2)

```
  
<br>

**V2 결과**

```{r, collapse=TRUE}
t34_allL.1.tmp <- t34_allL.1 %>% filter(Roi=="v2")
t34.aov1 <- aov_ez(id="subj", dv="z", data = t34_allL.1.tmp, within = c("rgCon"),
                   anova_table = list(correction = "none"))
nice(t34.aov1, es="pes") %>% kable(digits=3)

t34_allL.1.tmp %>% group_by(Roi) %>% rstatix::pairwise_t_test(z ~ rgCon, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(Roi, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) %>% kable(digits=3)

t34_allL.1.tmp %>% group_by(Roi) %>% 
  rstatix::cohens_d(z ~ rgCon, paired=T, ci = F) %>% kable(digits=2)
```

<br>

**V3 결과**

```{r, collapse=TRUE}
t34_allL.1.tmp <- t34_allL.1 %>% filter(Roi=="v3")
t34.aov1 <- aov_ez(id="subj", dv="z", data = t34_allL.1.tmp, within = c("rgCon"),
                   anova_table = list(correction = "none"))

nice(t34.aov1, es="pes") %>% kable(digits=3)

t34_allL.1.tmp %>% group_by(Roi) %>% rstatix::pairwise_t_test(z ~ rgCon, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(Roi, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) %>% kable(digits=3)

t34_allL.1.tmp %>% group_by(Roi) %>% 
  rstatix::cohens_d(z ~ rgCon, paired=T, ci = F) %>% kable(digits=2)
```

<br>

**V4 결과**

```{r, collapse=TRUE}
t34_allL.1.tmp <- t34_allL.1 %>% filter(Roi=="v4")
t34.aov1 <- aov_ez(id="subj", dv="z", data = t34_allL.1.tmp, within = c("rgCon"),
                   anova_table = list(correction = "none"))
nice(t34.aov1, es="pes") %>% kable(digits=3)

t34_allL.1.tmp %>% group_by(Roi) %>% rstatix::pairwise_t_test(z ~ rgCon, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(Roi, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) %>% kable(digits=3)

t34_allL.1.tmp %>% group_by(Roi) %>% 
  rstatix::cohens_d(z ~ rgCon, paired=T, ci = F) %>% kable(digits=2)
```

<br>

****

<br>

## Background Functional Connectivity - Phase 2 Replication 

<br>

### Behavioral Performance

<br>

Phase 2 Attention Phsae, 1-back task 수행의 전반적인 요약치와 t-test 결과를 아래에 표시하였다.

<br>

```{r, collapse=TRUE}
p2 <- read.csv("data/bg_behav.csv", header = T)

p2_l <- p2
p2_l$subj = factor(p2_l$subj)
p2_l <- p2_l %>% filter(subj!=99)
p2_l$run = factor(p2_l$run) 
p2_l$block = factor(p2_l$block) 
p2_l$cond = factor(p2_l$cond, levels=c(1,2), labels=c("face","scene")) 
# p2_l$catch = factor(p2_l$catch)
p2_l$rt = p2_l$rt*1000
p2_l$corr = 0
p2_l$corr[p2_l$catch==1 & p2_l$resp==1] =1
p2_l$type = 0
p2_l$type[p2_l$catch==1 & p2_l$resp==1] = 1 #hit
p2_l$type[p2_l$catch==1 & p2_l$resp==0] = 2 #miss
p2_l$type[p2_l$catch==0 & p2_l$resp==1] = 3 #fa
p2_l$type[p2_l$catch==0 & p2_l$resp==0] = 4 #cr
p2_l$type <- factor(p2_l$type, levels=c(1,2,3,4), labels=c("hit","miss","fa","cr"))

headTail(p2_l)
glimpse(p2_l, width = 70)

# length(unique(p2_l$subj))
# check number of trials for each condition/subj
# table(p2_l$subj)
# table(p2_l$cond,  p2_l$catch, p2_l$subj) 
```
  
<br>

두 주의 조건을 구분하지 않은 전반적인 수행 요약치 d-prime은 다음과 같다.

<br>

```{r, collapse=TRUE}
# subject-level, long format
dmy <- dummyVars(" ~ type", data = p2_l)
p2_2 <- data.frame(predict(dmy, newdata = p2_l))
p2_3 <- cbind(p2_l, p2_2)
p2_allL <- p2_3  %>% group_by(subj) %>%
  dplyr::summarise(hit=sum(`type.hit`), 
                 miss=sum(`type.miss`), 
                 fa=sum(`type.fa`),
                 cr=sum(`type.cr`),
                 targets=sum(`type.hit`)+sum(`type.miss`),
                 dists=sum(`type.fa`)+sum(`type.cr`),
                 hit.r=sum(`type.hit`)/(sum(`type.hit`)+sum(`type.miss`)), 
                 miss.r=sum(`type.miss`)/(sum(`type.hit`)+sum(`type.miss`)),
                 fa.r=sum(`type.fa`)/(sum(`type.fa`)+sum(`type.cr`)),
                 cr.r=sum(`type.cr`)/(sum(`type.fa`)+sum(`type.cr`))) %>%
  ungroup()
# p2_allL %>% kable(digits=2)

# subject-level, long format, calculating dprime
# indices <- psycho::dprime(p2_allL$hit, p2_allL$fa, p2_allL$miss, p2_allL$cr,
                          # p2_allL$targets, p2_allL$dists)
indices <- psycho::dprime(p2_allL$hit.r, p2_allL$fa.r, p2_allL$miss.r, p2_allL$cr.r,
                          1, 1)
p2_allL2 <- cbind(p2_allL, indices)
# p2_allL2 %>% kable(digits=2)

# check outlier
p2_allL3 <- p2_allL2 %>%
  mutate(lbound = mean(dprime)-3*sd(dprime),
         ubound = mean(dprime)+3*sd(dprime)) %>% 
  mutate(Outlier = (dprime < lbound)|(dprime > ubound)) %>% # set outlier
  ungroup()

# summary table: grand mean
p2_allG.mean <- p2_allL3 %>%
  summarise(dprime.m = mean(dprime), dprime.sd = sd(dprime)) %>%
  ungroup()
p2_allG.mean %>% kable(digits=2)
```

<br>

d prime 값이 0과 유의하게 다른지 one-sample t-test를 수행하였다. 

<br>

```{r, echo=T}

p_h1 <- p2_allL3 %>% 
  rstatix::t_test(dprime ~ 1, mu = 0, detailed= T, alternative = "two.sided") %>% 
  dplyr::select(estimate, conf.low, conf.high, df, statistic, p) 

p_h2 <- p2_allL3 %>% 
  rstatix::cohens_d(dprime ~ 1, mu = 0, ci = F) %>% 
  dplyr::select(effsize, magnitude) 

merge(p_h1, p_h2) %>% kable(digits=3)
```

<br>

주의 조건별 요약치는 다음과 같다.

<br>

  
```{r, collapse=TRUE}
# subject-level, long format
dmy <- dummyVars(" ~ type", data = p2_l)
p2_2 <- data.frame(predict(dmy, newdata = p2_l))
p2_3 <- cbind(p2_l, p2_2)
p2_allL <- p2_3  %>% group_by(subj, cond) %>%
  dplyr::summarise(hit=sum(`type.hit`), 
                 miss=sum(`type.miss`), 
                 fa=sum(`type.fa`),
                 cr=sum(`type.cr`),
                 targets=sum(`type.hit`)+sum(`type.miss`),
                 dists=sum(`type.fa`)+sum(`type.cr`),
                 hit.r=sum(`type.hit`)/(sum(`type.hit`)+sum(`type.miss`)), 
                 miss.r=sum(`type.miss`)/(sum(`type.hit`)+sum(`type.miss`)),
                 fa.r=sum(`type.fa`)/(sum(`type.fa`)+sum(`type.cr`)),
                 cr.r=sum(`type.cr`)/(sum(`type.fa`)+sum(`type.cr`))) %>%
  ungroup()
# p2_allL %>% kable(digits=2)

# subject-level, long format, calculating dprime
indices <- psycho::dprime(p2_allL$hit, p2_allL$fa, p2_allL$miss, p2_allL$cr,
                          p2_allL$targets, p2_allL$dists)
indices <- psycho::dprime(p2_allL$hit.r, p2_allL$fa.r, p2_allL$miss.r, p2_allL$cr.r,
                          1, 1)
p2_allL2 <- cbind(p2_allL, indices)
# p2_allL2 %>% kable(digits=2)

# check outlier
p2_allL3 <- p2_allL2 %>%
  mutate(lbound = mean(dprime)-3*sd(dprime),
         ubound = mean(dprime)+3*sd(dprime)) %>% 
  mutate(Outlier = (dprime < lbound)|(dprime > ubound)) %>% # set outlier
  ungroup()
# p2_allL3 %>% dplyr::select(subj, cond, hit, miss, fa, cr, dprime) %>%kable(digits=2)
p2_allG <- p2_allL3 %>% group_by(cond) %>% 
  summarise(dprime.m = mean(dprime), dprime.sd = sd(dprime)) %>%
  ungroup()

p2_allG$dprime.se <- Rmisc::summarySEwithin(data = p2_allL3, measurevar = "dprime", idvar = "subj", 
                                      withinvars = c("cond"))$se
p2_allG$dprime.ci <- Rmisc::summarySEwithin(data = p2_allL3, measurevar = "dprime", idvar = "subj", 
                                            withinvars = c("cond"))$ci
p2_allG <- p2_allG %>% 
  mutate(lower.ci = dprime.m-dprime.ci,
         upper.ci = dprime.m+dprime.ci)
p2_allG %>% dplyr::select(cond, dprime.m, dprime.sd, dprime.se, lower.ci, upper.ci) %>% kable(digits=2)
```

<br>

Face 조건과 Scene 조건 간의 paired t-test 결과, 두 조건 간의 수행 차이는 유의하지 않았다.

<br>

```{r, echo=T}
p_h1 <- p2_allL3 %>% 
  rstatix::pairwise_t_test(dprime ~ cond, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif)

p_h2 <- p2_allL3 %>% 
  rstatix::cohens_d(dprime ~ cond, paired=T, ci = F) %>% 
  dplyr::select(group1, group2, effsize, magnitude)

merge(p_h1, p_h2, by = c("group1", "group2")) %>% kable(digits=3)
```

<br>

### fMRI results 

<br>
  
**Al-aidroos et al., 2013. PNAS**의 결과를 재현하기 위해, Phase 2 Attention Phase에서 주의 조건에 따라 조절되는 상위 영역과 시각 영역 간의 Background Connectivity를 분석하였다.

<br>

```{r, collapse=TRUE}
t2 <- read.csv("data/p2_BG_main2_nsm.csv", header = T)

t2_l <- gather(t2, bgCon, fc, rFFA:PPA, factor_key=TRUE)

# change class of main factors: double to factor
t2_l$subj = factor(t2_l$subj, levels=c("rd_01","rd_02","rd_03","rd_04","rd_05",
                                       "rd_06","rd_07","rd_08","rd_09","rd_10",
                                       "rd_11","rd_12","rd_13","rd_14","rd_15",
                                       "rd_16", "rd_18", "rd_19", "rd_20",
                                       "rd_21", "rd_22", "rd_23", "rd_24", "rd_25"), 
                   labels=c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,19,20,21,22,23,24,25))

t2_l <- t2_l %>% filter(subj!=99)

t2_l$vRoi = factor(t2_l$vROIs) 
t2_l$bgCon = factor(t2_l$bgCon, 
                    levels=c("rFFA","lFFA","FFA","rPPA","lPPA","PPA"), 
                   labels=c("rFFA","lFFA","FFA","rPPA","lPPA","PPA"))
targ_bg = c("rFFA","rPPA")
targ_bg = c("FFA","PPA")
t2_l <- t2_l %>% filter(bgCon %in% targ_bg)
t2_l$hRoi <- t2_l$bgCon
t2_l$fRun <- t2_l$fcCon
t2_l$fRun <- factor(t2_l$fRun, 
                    levels=c("faceRun", "sceRun"),
                    labels=c("face", "scene"))

t2_l <- t2_l %>% dplyr::select(subj,vRoi,fRun,hRoi,fc)

glimpse(t2_l, width = 70)
```

<br>

요약치는 아래와 같다.

<br>

```{r, collapse=TRUE}

# subject-level, long format
t2_allL <- t2_l %>% group_by(subj, vRoi, fRun, hRoi) %>%
  dplyr::summarise(fc=mean(fc)) %>%
  ungroup()

# subject-level, wide format
t2_allW <- t2_allL %>% group_by(subj, vRoi) %>% spread(key=fRun, value = fc)
t2_allW1 <- t2_allL %>% group_by(subj, vRoi) %>% spread(key=hRoi, value = fc)

# summary table: grand mean
t2_allG <- t2_allL %>% group_by(vRoi, fRun, hRoi) %>%
  summarise(fc.m = mean(fc), fc.sd = sd(fc)) %>%
  ungroup()
t2_allG$fc.se <- Rmisc::summarySEwithin(data = t2_allL, measurevar = "fc", 
                                        idvar = "subj", withinvars = c("vRoi", "fRun", "hRoi"))$se
t2_allG$fc.ci <- Rmisc::summarySEwithin(data = t2_allL, measurevar = "fc", 
                                        idvar = "subj", withinvars = c("vRoi", "fRun", "hRoi"))$ci
t2_allG <- t2_allG %>% 
  mutate(lower.ci = fc.m-fc.ci,
         upper.ci = fc.m+fc.ci,
         lower.se = fc.m-fc.se,
         upper.se = fc.m+fc.se)
# for between-subject design. check help(summarySE)
t2_allG <- t2_allG %>% dplyr::select(vRoi, hRoi, fRun, fc.m, fc.sd, fc.se, lower.ci, upper.ci, lower.se, upper.se)
t2_allG %>% dplyr::select(fRun, hRoi, vRoi, fc.m) %>% 
  spread(key=vRoi, value=fc.m) %>% kable(digits=2)

```

<br>

아래 그래프에서 error bar는 95% ci를 나타내었다.

<br>


```{r, fig.width= 14, fig.height = 6}
t2_allG$fc <- t2_allG$fc.m

r2_bgfc.1 <- ggplot(data=t2_allL, aes(x=hRoi, y=fc, fill=fRun)) +
  geom_hline(yintercept=0, linetype='solid', color='black', alpha =1, size=0.4) +
  stat_summary(fun = mean, geom = "bar", position="dodge", na.rm = TRUE, 
               alpha = .9, width = 0.8,  size = 0.4, color = "black") +
  facet_grid(.~vRoi, scales="free_x", space = "free",
             labeller = labeller(vRoi = c("v1" = "V1","v2" = "V2","v3" = "V3","v4" = "V4"))) +
  geom_dotplot(data=t2_allL, aes(x=hRoi, y=fc, fill=fRun),
               binaxis = "y", stackdir = "center", stackratio = 1,
               color = "black", alpha = 0.5, #position = "nudge",
               position=position_dodge(0.8),
               inherit.aes = TRUE, binwidth = 0.01) +
  # geom_point(data=t2_allL, aes(x=hRoi, y=fc, fill=fRun), position = position_dodge(width=0.8),
  #            size=2, show.legend=F, color="gray90") +    
  # geom_segment(data=filter(t2_allW, hRoi == "ffa"), inherit.aes = FALSE,
  #              aes(x=0.8, y=filter(t2_allW, hRoi == "ffa")$face,
  #                  xend=1.2, yend=filter(t2_allW, hRoi == "ffa")$scene),
  #              color="gray90", alpha = .7) +  
  # geom_segment(data=filter(t2_allW, hRoi == "ppa"), inherit.aes = FALSE,
  #              aes(x=1.8, y=filter(t2_allW, hRoi == "ppa")$face,
  #                  xend=2.2, yend=filter(t2_allW, hRoi == "ppa")$scene),
  #              color="gray90", alpha = .7) +  
  # geom_pointrange(data=t2_allG, aes(x = hRoi, y=fc.m, ymin = lower.ci, ymax = upper.ci),
                  # position = position_dodge(0.80), color = "darkred", size = 1, show.legend = FALSE) +
  geom_errorbar(data=t2_allG, aes(ymin=lower.se, ymax=upper.se), width=.2,
                position=position_dodge(.8), color = "black") +
  scale_x_discrete(labels=c("FFA","PPA")) +
  
  scale_fill_manual(values = c("#feb24c", "#91bfdb"), # c("#feb24c", "#91bfdb"),
                    labels = c("Face attention", "Scene attention")) +
  coord_cartesian(ylim = c(-0.3, 0.9), clip = "on") +
  scale_y_continuous(breaks=c(-0.2, 0, 0.2, 0.4, 0.6, 0.8)) +
  labs(x = "", y = "Background connectivity (Zr)") +
  theme_bw(base_size = 18) +
  theme(axis.title = element_text(face = "plain", size = 16, color = "black"),
        axis.text = element_text(face = "plain", hjust = 0.5, size = 15, color = "black"),
        axis.line=element_line(),
        axis.title.y = element_text(face = "plain", size = 16, color = "black"),
        axis.title.x = element_text(face = "plain", size = 16, vjust = -2.5, color = "black"),
        axis.text.x = element_text(face = "plain", vjust = -1, size = 15, color = "black"),
        strip.text.x = element_text(face = "plain", size = 15, color = "black"),
        strip.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing=unit(1, "lines"),
        plot.margin = margin(1, 0.3, 1, 0.3, "cm"), 
        legend.title = element_blank(),
        legend.position="top")
r2_bgfc.1
# ggsave("fBGRED_bgfc1_verSM.jpg", plot = r2_bgfc.1, width=8, height=6, unit='in', dpi=600)

r2_bgfc.2 <- ggplot(data=t2_allL, aes(x=fRun, y=fc, fill=hRoi)) +
  geom_hline(yintercept=0, linetype='solid', color='black', alpha =1, size=0.4) +
  stat_summary(fun = mean, geom = "bar", position="dodge", na.rm = TRUE, 
               alpha = .9, width = 0.8,  size = 0.4, color = "black") +
  # geom_point(data=t2_allL, aes(x=fRun, y=fc, fill=hRoi), position = position_dodge(width=0.8),
  #            size=2, show.legend=F, color="gray90") +  
  # geom_segment(data=filter(t2_allW1,fRun == "face"), inherit.aes = FALSE,
  #              aes(x=0.8, y=filter(t2_allW1, fRun == "face")$ffa,
  #                  xend=1.2, yend=filter(t2_allW1, fRun == "face")$ppa),
  #              color="gray90", alpha = .7) +  
  # geom_segment(data=filter(t2_allW1,fRun == "scene"), inherit.aes = FALSE,
  #              aes(x=1.8, y=filter(t2_allW1, fRun == "scene")$ffa,
  #                  xend=2.2, yend=filter(t2_allW1, fRun == "scene")$ppa),
  #              color="gray90", alpha = .7) +  
  # geom_pointrange(data=t2_allG, aes(x = fRun, y=fc.m, ymin = lower.ci, ymax = upper.ci),
  #                 position = position_dodge(0.80), color = "darkred", size = 1, show.legend = FALSE) +
  geom_errorbar(data=t2_allG, aes(ymin=lower.ci, ymax=upper.ci), width=.2,
                position=position_dodge(.8), color = "black") +
  facet_grid(.~vRoi, scales="free_x", space = "free",
             labeller = labeller(vRoi = c("v1" = "V1","v2" = "V2","v3" = "V3","v4" = "V4"))) +
  scale_x_discrete(labels=c("Face","Scene")) +
  # scale_x_discrete(labels=c("Face\nattention","Scene\nattention")) +
  scale_fill_manual(values = c("#B35750", "#628DCF"), # c("#feb24c", "#91bfdb"),
                    labels = c("FFA", "PPA")) +
  coord_cartesian(ylim = c(-0.1, 0.6), clip = "on") +
  labs(x = " ", y = "Background connectivity (Zr)") +
  theme_bw(base_size = 18) +
  theme(axis.title = element_text(face = "plain", size = 16, color = "black"),
        axis.text = element_text(face = "plain", hjust = 0.5, size = 15, color = "black"),
        axis.line=element_line(),
        axis.title.y = element_text(face = "plain", size = 16, color = "black"),
        axis.title.x = element_text(face = "plain", size = 16, vjust = -2.5, color = "black"),
        axis.text.x = element_text(face = "plain", vjust = -1, size = 15, color = "black"),
        strip.text.x = element_text(face = "plain", size = 15, color = "black"),
        strip.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing=unit(1, "lines"),
        plot.margin = margin(1, 0.3, 1, 0.3, "cm"), 
        legend.title = element_blank(),
        legend.position="top")
# r2_bgfc.2
# ggsave("fBGRED_bgfc2_verSM.jpg", plot = r2_bgfc.2, width=8, height=6, unit='in', dpi=600)

ggarrange(r2_bgfc.1, r2_bgfc.2, ncol=2, 
          labels=c("A","B"))

```

<br>

각 시각 영역(v1, v2, v3, v4), 주의 조건(face vs. scene)과 관심 상위 영역(FFA vs. PPA)을 요인으로 4 x 2 x 2 혼합 요인 분산분석을 수행하였다. 분석 결과에는 삼원 상호 작용이 포함되어 있으나 시각 영역에 따른 효과는 관심 효과가 아님에 주의할 필요가 있다.

<br>


```{r, collapse=TRUE}
t2.aov1 <- aov_ez(id="subj", dv="fc", data = t2_allL, within = c("vRoi", "fRun", "hRoi"), 
                  anova_table = list(correction = "none"))
nice(t2.aov1, es="pes") %>% kable(digits=3)
```

<br>

사후 검정 결과는 아래와 같다.

<br>

```{r, collapse=TRUE}
ph1 <- t2_allL %>% 
  group_by(vRoi, hRoi) %>% 
  rstatix::pairwise_t_test(fc ~ fRun, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(vRoi, hRoi, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) 

ph2 <- t2_allL %>% 
  group_by(vRoi, hRoi) %>%  
  rstatix::cohens_d(fc ~ fRun, paired=T, ci = F) %>% 
  dplyr::select(vRoi, hRoi, group1, group2, effsize, magnitude)

merge(ph1, ph2, by = c("vRoi", "hRoi", "group1", "group2")) %>% kable(digits=3)


ph1 <- t2_allL %>% 
  group_by(vRoi, fRun) %>% 
  rstatix::pairwise_t_test(fc ~ hRoi, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(vRoi, fRun, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) 

ph2 <- t2_allL %>% 
  group_by(vRoi, fRun) %>%  
  rstatix::cohens_d(fc ~ hRoi, paired=T, ci = F) %>% 
  dplyr::select(vRoi, fRun, group1, group2, effsize, magnitude)

merge(ph1, ph2, by = c("vRoi", "fRun", "group1", "group2")) %>% kable(digits=3)

```


<br>

구형성 가정 위배에 따른 보정을 고려하여 시각 영역별 분석을 수행하였다.

<br>

**V1 결과**

```{r, collapse=TRUE}
t2_allL.tmp <- t2_allL %>% filter(vRoi=="v1")

t2.aov1.1 <- aov_ez(id="subj", dv="fc", data = t2_allL.tmp, within = c("fRun", "hRoi"),
                    anova_table = list(correction = "none"))
nice(t2.aov1.1, es="pes") %>% kable(digits=3)

ph1 <- t2_allL.tmp %>% 
  group_by(vRoi, hRoi) %>% 
  rstatix::pairwise_t_test(fc ~ fRun, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(vRoi, hRoi, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) 

ph2 <- t2_allL.tmp %>% 
  group_by(vRoi, hRoi) %>%  
  rstatix::cohens_d(fc ~ fRun, paired=T, ci = F) %>% 
  dplyr::select(vRoi, hRoi, group1, group2, effsize, magnitude)

merge(ph1, ph2, by = c("vRoi", "hRoi", "group1", "group2")) %>% kable(digits=3)


ph1 <- t2_allL.tmp %>% 
  group_by(vRoi, fRun) %>% 
  rstatix::pairwise_t_test(fc ~ hRoi, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(vRoi, fRun, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) 

ph2 <- t2_allL.tmp %>% 
  group_by(vRoi, fRun) %>%  
  rstatix::cohens_d(fc ~ hRoi, paired=T, ci = F) %>% 
  dplyr::select(vRoi, fRun, group1, group2, effsize, magnitude)

merge(ph1, ph2, by = c("vRoi", "fRun", "group1", "group2")) %>% kable(digits=3)

```

<br>

**V2 결과**

```{r, collapse=TRUE}
t2_allL.tmp <- t2_allL %>% filter(vRoi=="v2")

t2.aov1.1 <- aov_ez(id="subj", dv="fc", data = t2_allL.tmp, within = c("fRun", "hRoi"),
                    anova_table = list(correction = "none"))
nice(t2.aov1.1, es="pes") %>% kable(digits=3)

ph1 <- t2_allL.tmp %>% 
  group_by(vRoi, hRoi) %>% 
  rstatix::pairwise_t_test(fc ~ fRun, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(vRoi, hRoi, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) 

ph2 <- t2_allL.tmp %>% 
  group_by(vRoi, hRoi) %>%  
  rstatix::cohens_d(fc ~ fRun, paired=T, ci = F) %>% 
  dplyr::select(vRoi, hRoi, group1, group2, effsize, magnitude)

merge(ph1, ph2, by = c("vRoi", "hRoi", "group1", "group2")) %>% kable(digits=3)


ph1 <- t2_allL.tmp %>% 
  group_by(vRoi, fRun) %>% 
  rstatix::pairwise_t_test(fc ~ hRoi, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(vRoi, fRun, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) 

ph2 <- t2_allL.tmp %>% 
  group_by(vRoi, fRun) %>%  
  rstatix::cohens_d(fc ~ hRoi, paired=T, ci = F) %>% 
  dplyr::select(vRoi, fRun, group1, group2, effsize, magnitude)

merge(ph1, ph2, by = c("vRoi", "fRun", "group1", "group2")) %>% kable(digits=3)
```

<br>

**V3 결과**

```{r, collapse=TRUE}
t2_allL.tmp <- t2_allL %>% filter(vRoi=="v3")

t2.aov1.1 <- aov_ez(id="subj", dv="fc", data = t2_allL.tmp, within = c("fRun", "hRoi"),
                    anova_table = list(correction = "none"))
nice(t2.aov1.1, es="pes") %>% kable(digits=3)

ph1 <- t2_allL.tmp %>% 
  group_by(vRoi, hRoi) %>% 
  rstatix::pairwise_t_test(fc ~ fRun, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(vRoi, hRoi, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) 

ph2 <- t2_allL.tmp %>% 
  group_by(vRoi, hRoi) %>%  
  rstatix::cohens_d(fc ~ fRun, paired=T, ci = F) %>% 
  dplyr::select(vRoi, hRoi, group1, group2, effsize, magnitude)

merge(ph1, ph2, by = c("vRoi", "hRoi", "group1", "group2")) %>% kable(digits=3)


ph1 <- t2_allL.tmp %>% 
  group_by(vRoi, fRun) %>% 
  rstatix::pairwise_t_test(fc ~ hRoi, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(vRoi, fRun, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) 

ph2 <- t2_allL.tmp %>% 
  group_by(vRoi, fRun) %>%  
  rstatix::cohens_d(fc ~ hRoi, paired=T, ci = F) %>% 
  dplyr::select(vRoi, fRun, group1, group2, effsize, magnitude)

merge(ph1, ph2, by = c("vRoi", "fRun", "group1", "group2")) %>% kable(digits=3)
```

<br>

**V4 결과**

```{r, collapse=TRUE}
t2_allL.tmp <- t2_allL %>% filter(vRoi=="v4")

t2.aov1.1 <- aov_ez(id="subj", dv="fc", data = t2_allL.tmp, within = c("fRun", "hRoi"),
                    anova_table = list(correction = "none"))
nice(t2.aov1.1, es="pes") %>% kable(digits=3)

ph1 <- t2_allL.tmp %>% 
  group_by(vRoi, hRoi) %>% 
  rstatix::pairwise_t_test(fc ~ fRun, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(vRoi, hRoi, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) 

ph2 <- t2_allL.tmp %>% 
  group_by(vRoi, hRoi) %>%  
  rstatix::cohens_d(fc ~ fRun, paired=T, ci = F) %>% 
  dplyr::select(vRoi, hRoi, group1, group2, effsize, magnitude)

merge(ph1, ph2, by = c("vRoi", "hRoi", "group1", "group2")) %>% kable(digits=3)


ph1 <- t2_allL.tmp %>% 
  group_by(vRoi, fRun) %>% 
  rstatix::pairwise_t_test(fc ~ hRoi, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(vRoi, fRun, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) 

ph2 <- t2_allL.tmp %>% 
  group_by(vRoi, fRun) %>%  
  rstatix::cohens_d(fc ~ hRoi, paired=T, ci = F) %>% 
  dplyr::select(vRoi, fRun, group1, group2, effsize, magnitude)

merge(ph1, ph2, by = c("vRoi", "fRun", "group1", "group2")) %>% kable(digits=3)
```

<br>

****

<br>

## Linking voxel-wise background functional connectivity to the redundancy gain effect (voxel-level)

<br>

### 각 복셀별 RG Difference Score와 bgFC 간의 상관 관계 (P2 bgFC)
  
<br>
  
관심 시각 영역 (V1~V4) 에서 Redundancy Gain Effect가 PPA-VC Voxel-wise Background Connectivity(bgFC)의 강도에 따라 조절되는지 검증하기 위해 상관 분석을 수행하였다. 각 참가자 내의 관심 영역에서 voxel 별로 4-Same - 4-Diff의 Difference Score를 계산한 후 각 voxel 별 PPA-VC bgFC 값과 상관을 계산하였다. 이 분석에서 0 보다 유의하게 상관계수가 높다는 것은 bgFC 강도가 높을수록 Redundacy Gain Effect의 강도도 높다는 것을 나타낸다. 

<br>

```{r, collapse=TRUE}
s1 <- read.csv("data/p12_RGandBG_corr_main3_nsm.csv", header = T)

s1_l <- s1
# change class of main factors: double to factor
s1_l$subj = factor(s1_l$subj, levels=c("rd_01","rd_02","rd_03","rd_04","rd_05",
                                       "rd_06","rd_07","rd_08","rd_09","rd_10",
                                       "rd_11","rd_12","rd_13","rd_14","rd_15",
                                       "rd_16", "rd_18", "rd_19", "rd_20",
                                       "rd_21", "rd_22", "rd_23", "rd_24", "rd_25"), 
                   labels=c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,18,19,20,21,22,23,24,25))

# s1_l <- s1_l %>% filter(subj!=4, subj!=5, subj!=6, subj!=8)

s1_l$vRoi = factor(s1_l$vRoi) 
s1_l$hRoi = factor(s1_l$hRoi, levels = c("rPPA", "lPPA", "PPA")) 

```

<br>

각 관심 영역에서 voxel 별 difference score와 bgFC의 pearson correlation coefficient를 Fisher의 Z transform하여 요약하였다.

<br>

```{r, collapse=TRUE}
s1_allL <- s1_l %>% 
  dplyr::select(subj, hRoi, vRoi, Zr) %>% 
  group_by(subj, hRoi, vRoi) %>%
  dplyr::summarise(Zr=mean(Zr)) %>%
  ungroup()
# s1_allL %>% kable(digits=2)

# subject-level, wide format
s1_allW <- s1_allL %>% dplyr::select(subj, hRoi, vRoi, Zr) %>% spread(key=vRoi, value = Zr)
# s1_allW %>% kable(digits=2)

# summary table: grand mean
s1_allG <- s1_allL %>% group_by(hRoi, vRoi) %>%
  summarise(Zr.m = mean(Zr), Zr.sd = sd(Zr)) %>%
  ungroup()
s1_allG$Zr.se <- Rmisc::summarySEwithin(data = s1_allL, measurevar = "Zr", 
                                        idvar = "subj", withinvars = c("hRoi","vRoi"))$se
s1_allG$Zr.ci <- Rmisc::summarySEwithin(data = s1_allL, measurevar = "Zr", 
                                        idvar = "subj", withinvars = c("hRoi","vRoi"))$ci
s1_allG <- s1_allG %>% 
  mutate(lower.ci = Zr.m-Zr.ci,
         upper.ci = Zr.m+Zr.ci,
         lower.se = Zr.m-Zr.se,
         upper.se = Zr.m+Zr.se)
s1_allG %>% dplyr::select(hRoi, vRoi, Zr.m) %>% 
  spread(key=vRoi, value = Zr.m) %>% kable(digits=2)
```

<br>

각 관심 영역에서 voxel 별 difference score와 bgFC의 Zr을 그래프로 나타내었다. 점은 평군, error bar는 95% CI를 나타낸다.

<br>

```{r, fig.width= 10, fig.height=6}

s1_allL.tmp <- s1_allL
r5_RG_with_bgfc.1 <- ggplot(data=s1_allL.tmp, aes(x=vRoi, y=Zr)) + #, fill=vRoi
  geom_hline(yintercept=0, linetype='solid', color='black', alpha =1, size=0.4) +
  geom_violin(width = 0.5, trim=TRUE) + 
  ggbeeswarm::geom_quasirandom(color = "blue", size = 3, alpha = 0.2, width = 0.2) +
  facet_grid(.~hRoi, scales="free_x", space = "free") +
  
  #stat_summary(fun = mean, geom = "bar", position="dodge", na.rm = TRUE, alpha = .9, width = 0.8,  size = 1.02, show.legend=F) +
  #geom_point(data=s1_allL, aes(x=vRoi, y=Zr, fill=vRoi), position = position_dodge(width=0.8),
  #           size=2, show.legend=F, color="gray90") +  
  geom_pointrange(data=s1_allG, aes(x = vRoi, y=Zr.m, ymin = lower.ci, ymax = upper.ci),
                  position = position_dodge(0.80), color = "darkred", size = 0.8, show.legend = FALSE) +
  
  # geom_errorbar(data=s1_allG, aes(ymin=lower.ci, ymax=upper.ci), width=.2,
  #               position=position_dodge(.8), color = "black") +
  
  scale_x_discrete(labels=c("V1","V2","V3","V4")) +
  scale_fill_manual(values = c("#B1D4E0", "#2E8BC0","#0C2D48", "#145DA0")) +
  coord_cartesian(ylim = c(-0.6, 0.9), clip = "on") +
  labs(x = "", y = "Correlation coefficient (Zr)") +
  theme_bw(base_size = 18) +
  theme(axis.title = element_text(face = "plain", size = 16, color = "black"),
        axis.text = element_text(face = "plain", hjust = 0.5, size = 15, color = "black"),
        axis.line=element_line(),
        axis.title.y = element_text(face = "plain", size = 16, color = "black"),
        axis.title.x = element_text(face = "plain", size = 16, vjust = -2.5, color = "black"),
        axis.text.x = element_text(face = "plain", vjust = -1, size = 15, color = "black"),
        strip.text.x = element_text(face = "plain", size = 15, color = "black"),
        strip.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing=unit(1, "lines"),
        plot.margin = margin(1, 0.3, 1, 0.3, "cm"), 
        legend.title = element_blank(),
        legend.position="top")

r5_RG_with_bgfc.1

# ggsave("fBGRED_main7_verNSM.jpg", plot = r5_RG_with_bgfc.1, width=10, height=6, unit='in', dpi=600)
s1_allL.tmp <- s1_allL %>% filter(hRoi == "PPA")
s1_allG.tmp <- s1_allG %>% filter(hRoi == "PPA")
s1_allG.tmp$Zr <- s1_allG.tmp$Zr.m
r5_RG_with_bgfc.1 <- ggplot(data=s1_allL.tmp, aes(x=vRoi, y=Zr, fill = vRoi)) + #, fill=vRoi
  # geom_violin(width = 0.5, trim=TRUE) + 
  # ggbeeswarm::geom_quasirandom(color = "blue", size = 3, alpha = 0.2, width = 0.2) +
  stat_summary(fun = mean, geom = "bar", position="dodge", na.rm = TRUE, alpha = .9, width = 0.8,  size = 1.02, show.legend=F) +
  geom_hline(yintercept=0, linetype='solid', alpha =1, size=0.75) + #, color='black'
  # geom_jitter(data=s1_allL.tmp, aes(x=vRoi, y=Zr, color=vRoi),
  #             position=position_jitter(0.2), cex=2) +
  geom_quasirandom(data=s1_allL.tmp, aes(x=vRoi, y=Zr),
                   color = "black", fill = "#adadad",
                   alpha = 0.3, #position = "nudge",
                   width = 0.3,
                   size = 1.3,
                   position=position_jitter(0.05),
                   # position="jitter",
                   inherit.aes = TRUE,
                   show.legend = F) +

  # geom_dotplot(data=s1_allL.tmp, aes(x=vRoi, y=Zr, fill=vRoi),
  #              binaxis = "y", stackdir = "center", stackratio = 1.2,
  #              color = "black", alpha = 0.5, #position = "nudge",
  #              position=position_jitter(0.2),
  #              # position="jitter",
  #              inherit.aes = TRUE, binwidth = 0.02) +
  # geom_point(data=s1_allL.tmp, aes(x=vRoi, y=Zr, fill=vRoi), position = position_jitter(0.2),
  #           size=2, show.legend=F, color="gray90") +
  # geom_pointrange(data=s1_allG.tmp, aes(x = vRoi, y=Zr.m, ymin = lower.se, ymax = upper.se),
  #                 position = position_dodge(0.80), color = "darkred", size = 0.8, show.legend = FALSE) +
  geom_errorbar(data=s1_allG.tmp, aes(ymin=lower.se, ymax=upper.se), width=.2,
                position=position_dodge(.8), color = "black") +
  
  scale_x_discrete(labels=c("V1","V2","V3","V4")) +
  scale_fill_manual(values = c("#adadad", "#adadad","#adadad", "#adadad")) +
  # scale_fill_manual(values = c("#B1D4E0", "#2E8BC0","#0C2D48", "#145DA0")) +
  coord_cartesian(ylim = c(-0.5, 0.7), clip = "on") +
  labs(x = "", y = "Correlation coefficient (Zr)") +
  theme_bw(base_size = 18) +
  theme(axis.title = element_text(face = "plain", size = 16, color = "black"),
        axis.text = element_text(face = "plain", hjust = 0.5, size = 15, color = "black"),
        axis.line=element_line(),
        axis.title.y = element_text(face = "plain", size = 16, color = "black"),
        axis.title.x = element_text(face = "plain", size = 16, vjust = -2.5, color = "black"),
        axis.text.x = element_text(face = "plain", vjust = -1, size = 15, color = "black"),
        strip.text.x = element_text(face = "plain", size = 15, color = "black"),
        strip.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.spacing=unit(1, "lines"),
        plot.margin = margin(1, 0.3, 1, 0.3, "cm"), 
        legend.title = element_blank(),
        legend.position="top")

r5_RG_with_bgfc.1
# ggsave("fBGRED_main8_verNSM.jpg", plot = r5_RG_with_bgfc.1, width=8, height=6, unit='in', dpi=600)
```

<br>

```{r, collapse=TRUE}
s1.aov1.1 <- aov_ez(id="subj", dv="Zr", data = s1_allL , within = c("vRoi", "hRoi"),
                    anova_table = list(correction = "none"))
#summary(t4.2.aov4.2)
nice(s1.aov1.1, es="pes") %>% kable(digits=3)

ph1 <- s1_allL %>% 
  group_by(hRoi) %>% 
  rstatix::pairwise_t_test(Zr ~ vRoi, 
                           p.adjust.method="bonferroni", 
                           paired=T, detailed=T) %>% 
  dplyr::select(hRoi, group1, group2, estimate, conf.low, conf.high, df, statistic, p.adj, p.adj.signif) 

ph2 <- s1_allL %>% 
  group_by(hRoi) %>%  
  rstatix::cohens_d(Zr ~ vRoi, paired=T, ci = F) %>% 
  dplyr::select(hRoi, group1, group2, effsize, magnitude)

merge(ph1, ph2, by = c("hRoi",  "group1", "group2")) %>% kable(digits=3)

```


<br>

각 관심 영역에서 voxel 별 difference score와 bgFC의 Zr이 0보다 유의하게 큰 지 확인하기 위해 단일 표본 t-검정을 수행하였다.


<br>

```{r, collapse=TRUE}

p_h1 <- s1_allL %>% 
  group_by(hRoi, vRoi) %>% 
  rstatix::t_test(Zr ~ 1, mu = 0, detailed= T, alternative = "two.sided") %>% 
  dplyr::select(hRoi, vRoi, estimate, conf.low, conf.high, df, statistic, p) 


p_h2 <- s1_allL %>% 
  group_by(hRoi, vRoi) %>% 
  rstatix::cohens_d(Zr ~ 1, mu = 0, ci = F) %>% 
  dplyr::select(hRoi, vRoi, effsize, magnitude) 

merge(p_h1, p_h2, by = c("hRoi", "vRoi")) %>% kable(digits=3)

```

<br>

****

<br>


<br>


<br>

***

<br>

# Session Info

<Br>

```{r, collapse=TRUE}
sessionInfo()
```